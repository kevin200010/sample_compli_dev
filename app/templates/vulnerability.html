{% extends 'layout.html' %}
{% block content %}
<style>
    /* Button styles based on severity levels */
    .button-severity-critical { background-color: rgb(129, 13, 13); }
    .button-severity-high { background-color: rgb(242, 69, 69); }
    .button-severity-medium { background-color: rgb(233, 156, 13); }
    .button-severity-low { background-color: rgb(238, 255, 87); }
    .button-severity-informational { background-color: blue; }

    /* Circle styles to indicate severity visually */
    .severity-circle {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 50%; /* Makes the circle shape */
        border: 1px solid black; /* Black border for the circle */
        margin-right: 10px; /* Space between the circle and text */
    }

    /* New class for the sub-accordion background color */
    .sub-accordion-bg {
        background-color: lightgray; /* Light gray background for sub-accordion */
        padding: 10px; /* Add some padding for better spacing */
        border-radius: 5px; /* Optional: round the corners */
    }
    .cli-command {
    background-color: #f4f4f4;
    padding: 2px 5px;
    border-radius: 3px;
    border: 1px solid #ddd;
    color: #d63384; /* Optional: Add a different color for emphasis */
}
</style>

<div class="accordion-1">
    <div class="container">
        <div class="row my-5">
            <div class="col-md-6 mx-auto text-center">
                <h2 class="text-white">AWS Account Vulnerability</h2>
                <!-- Form to download CSV for the AWS account -->
                <form action="{{ url_for('account.download_csv', email=email, alias=account) }}" autocomplete="off"
                      method="get">
                    <button class="btn mb-0 bg-gradient-dark" id="download" type="submit">Download CSV</button>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="accordion" id="accordionRental">
                    <!-- Iterate over grouped findings to create accordion items -->
                    {% for title, findings in grouped_findings.items() %}
                    <div class="accordion-item mb-3">
                        <h5 class="accordion-header" id="heading-{{ loop.index }}">
                            <!-- Accordion button that expands/collapses the findings -->
                            <button aria-controls="collapse-{{ loop.index }}"
                                    aria-expanded="false"
                                    class="accordion-button border-bottom font-weight-bold"
                                    data-bs-target="#collapse-{{ loop.index }}"
                                    data-bs-toggle="collapse"
                                    onclick="toggleIcons(this)" type="button">
                                <!-- Severity circle indicator -->
                                <span class="severity-circle {{ 'button-severity-' ~ findings[0].Severity|lower }}"></span>
                                {{ title }} <!-- Title of the findings group -->
                                <!-- Icons to indicate expansion state -->
                                <i aria-hidden="true"
                                   class="collapse-icon fa fa-plus text-xs pt-1 position-absolute end-0 me-3"></i>
                                <i aria-hidden="true"
                                   class="collapse-open-icon fa fa-minus text-xs pt-1 position-absolute end-0 me-3"
                                   style="display:none;"></i>
                            </button>
                        </h5>
                        <div aria-labelledby="heading-{{ loop.index }}"
                             class="accordion-collapse collapse"
                             data-bs-parent="#accordionRental"
                             id="collapse-{{ loop.index }}">
                            <div class="accordion-body text-sm opacity-8">
                                <!-- Check if there's only one finding -->
                                {% if findings|length <= 1 %}
                                <p><b>Resource:</b> {{ findings[0].Resource }}</p>
                                <p><b>ID:</b> {{ findings[0].Id }}</p>
                                <p><b>Description:</b> {{ findings[0].Description }}</p>
                                <p><b>Severity:</b> {{ findings[0].Severity }}</p>
                                <p><b>AwsAccountId:</b> {{ findings[0].AwsAccountId }}</p>
                                <p><b>LastObservedAt:</b> {{ findings[0].LastObservedAt }}</p>
                                <p><b>Recommendation URL:</b> <a href="{{ findings[0].RecommendationUrl }}"
                                                                 target="_blank">{{ findings[0].RecommendationUrl }}</a>
                                </p>

                                <!-- Check if details are available -->
                                {% if findings[0].Details %}
                                <p><b>Details:</b></p>
                                <ul>
                                    {% for detail_key, detail_value in findings[0].Details.items() %}
                                    <li><b>{{ detail_key }}:</b>
                                        <ul>
                                            {% if detail_value is mapping %}
                                            {% for sub_key, sub_value in detail_value.items() %}
                                            <li><b>{{ sub_key }}:</b>
                                                {% if sub_value is iterable and sub_value is not string %}
                                                <ul>
                                                    {% for item in sub_value %}
                                                    {% if item is mapping %}
                                                    <li>
                                                        {% for item_key, item_value in item.items() %}
                                                        <b>{{ item_key }}:</b> {{ item_value }}
                                                        {% endfor %}
                                                    </li>
                                                    {% else %}
                                                    <li>{{ item }}</li>
                                                    {% endif %}
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                {{ sub_value }}
                                                {% endif %}
                                            </li>
                                            {% endfor %}
                                            {% else %}
                                            {{ detail_value }}
                                            {% endif %}
                                        </ul>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p><b>Details:</b> Not available</p>
                                {% endif %}
                                <!-- Button to get a recommendation with CompliTruAI -->
                                <button class="btn mb-0 bg-gradient-primary button4 print-json-button"
                                        data-finding='{{ findings[0] | tojson | safe }}' type="button">Get a
                                    recommendation with CompliTruAI
                                </button>
                                {% else %}
                                <!-- Nested Accordion for multiple findings -->
                                <div class="accordion mt-3" id="nestedAccordion">
                                    {% for finding in findings %}
                                    <div class="accordion-item mb-3">
                                        <h5 class="accordion-header" id="nestedHeading-{{ loop.index }}">
                                            <button aria-controls="nestedCollapse-{{ loop.index }}"
                                                    aria-expanded="false"
                                                    class="accordion-button border-bottom font-weight-bold"
                                                    data-bs-target="#nestedCollapse-{{ loop.index }}"
                                                    data-bs-toggle="collapse"
                                                    onclick="toggleNestedIcons(this)" type="button">
                                                {{ finding.Resource }} <!-- Display resource name -->
                                                <i aria-hidden="true"
                                                   class="collapse-icon fa fa-plus text-xs pt-1 position-absolute end-0 me-3"></i>
                                                <i aria-hidden="true"
                                                   class="collapse-open-icon fa fa-minus text-xs pt-1 position-absolute end-0 me-3"
                                                   style="display:none;"></i>
                                            </button>
                                        </h5>
                                        <div aria-labelledby="nestedHeading-{{ loop.index }}"
                                             class="accordion-collapse collapse"
                                             data-bs-parent="#nestedAccordion"
                                             id="nestedCollapse-{{ loop.index }}">
                                            <div class="accordion-body text-sm opacity-8 sub-accordion-bg">
                                                <!-- Apply light gray background here -->
                                                <p><b>Resource:</b> {{ finding.Resource }}</p>
                                                <p><b>ID:</b> {{ finding.Id }}</p>
                                                <p><b>Description:</b> {{ finding.Description }}</p>
                                                <p><b>Severity:</b> {{ finding.Severity }}</p>
                                                <p><b>AwsAccountId:</b> {{ finding.AwsAccountId }}</p>
                                                <p><b>LastObservedAt:</b> {{ finding.LastObservedAt }}</p>
                                                <p><b>Recommendation URL:</b> <a href="{{ finding.RecommendationUrl }}"
                                                                                 target="_blank">{{
                                                    finding.RecommendationUrl }}</a></p>

                                                <!-- Check if details are available for the finding -->
                                                {% if finding.Details %}
                                                <p><b>Details:</b></p>
                                                <ul>
                                                    {% for detail_key, detail_value in finding.Details.items() %}
                                                    <li><b>{{ detail_key }}:</b>
                                                        <ul>
                                                            {% if detail_value is mapping %}
                                                            {% for sub_key, sub_value in detail_value.items() %}
                                                            <li><b>{{ sub_key }}:</b>
                                                                {% if sub_value is iterable and sub_value is not string
                                                                %}
                                                                <ul>
                                                                    {% for item in sub_value %}
                                                                    {% if item is mapping %}
                                                                    <li>
                                                                        {% for item_key, item_value in item.items() %}
                                                                        <b>{{ item_key }}:</b> {{ item_value }}
                                                                        {% endfor %}
                                                                    </li>
                                                                    {% else %}
                                                                    <li>{{ item }}</li>
                                                                    {% endif %}
                                                                    {% endfor %}
                                                                </ul>
                                                                {% else %}
                                                                {{ sub_value }}
                                                                {% endif %}
                                                            </li>
                                                            {% endfor %}
                                                            {% else %}
                                                            {{ detail_value }}
                                                            {% endif %}
                                                        </ul>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                <p><b>Details:</b> Not available</p>
                                                {% endif %}
                                                <!-- Button to get a recommendation with CompliTruAI for each finding -->
                                                <button class="btn mb-0 bg-gradient-primary button4 print-json-button"
                                                        data-finding='{{ finding | tojson | safe }}' type="button">Get a
                                                    recommendation with CompliTruAI
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal that displays the GPT remediation recommendation output -->
<div class="modal slide-in-bottom" id="gptResultModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header center2">
                <h4 class="modal-title">Your Insight</h4>
                <!-- View AWS CLI Commands button in the modal header -->
                <!-- Close button -->
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div id="jsonContent"></div>
            </div>
            <div class="modal-footer">
                <!-- <a id="viewCommandsBtn" href="#" class="btn button4 btn-primary">View AWS CLI Commands</a> -->
                <button class="btn mb-0 bg-gradient-primary button4" id="viewCommandsBtn">View AWS CLI Commands</button>
                <button class="btn mb-0 button4 btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal to have only the Commands to execute -->
<div class="modal fade slide-in-bottom" id="commandsModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header center2">
                <h4 class="modal-title">AWS CLI Commands</h4>
                <button aria-label="Close" class="text-dark btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div id="commandsModalContent">
                    <form id="commandsForm">

                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn mb-0 button4 btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    
  function toggleNestedIcons(btn) {
      const plus  = btn.querySelector('.collapse-icon');
      const minus = btn.querySelector('.collapse-open-icon');
      const open  = btn.getAttribute('aria-expanded') === 'true';
      plus.style.display  = open ? 'none'  : 'inline';
      minus.style.display = open ? 'inline' : 'none';
  }
    // Function to toggle icons
    function toggleIcons(button, isOpen) {
        const collapseIcon = button.querySelector('.collapse-icon');
        const collapseOpenIcon = button.querySelector('.collapse-open-icon');

        if (isOpen) {
            collapseIcon.style.display = 'none'; // Hide plus icon
            collapseOpenIcon.style.display = 'inline'; // Show minus icon
        } else {
            collapseIcon.style.display = 'inline'; // Show plus icon
            collapseOpenIcon.style.display = 'none'; // Hide minus icon
        }
    }

    // Add event listeners to the accordion buttons
    document.addEventListener('DOMContentLoaded', function () {
        const accordions = document.querySelectorAll('.accordion-button');

        accordions.forEach((button) => {
            const targetId = button.getAttribute('data-bs-target');

            // Event listener for showing the accordion
            document.querySelector(targetId).addEventListener('shown.bs.collapse', function () {
                toggleIcons(button, true); // Show minus icon when opened
            });

            // Event listener for hiding the accordion
            document.querySelector(targetId).addEventListener('hidden.bs.collapse', function () {
                toggleIcons(button, false); // Show plus icon when closed
            });

            // Manual toggle when the button is clicked
            button.addEventListener('click', function () {
                const isOpen = button.getAttribute('aria-expanded') === 'true'; // Check current state
                toggleIcons(button, !isOpen); // Toggle icons based on current state
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('.print-json-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const findingJson = JSON.parse(e.target.getAttribute('data-finding'));

                // Show loader
                showLoader();

                // Send finding to the server
                fetch('/gpt_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ finding_json: findingJson })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    const updatedFinding = data.updated_finding;
                    const awsCliCommands = data.aws_cli_commands;

                    // Show updated finding in the modal
                    document.getElementById('jsonContent').innerHTML = updatedFinding;
                    const gptResultModal = new bootstrap.Modal(document.getElementById('gptResultModal'));
                    gptResultModal.show();

                    // Update "View AWS CLI Commands" button to handle commands
                    const viewCommandsBtn = document.getElementById('viewCommandsBtn');
                    viewCommandsBtn.onclick = () => {
                        // Populate the second modal with AWS CLI commands
                        const commandsModalContent = document.getElementById('commandsModalContent');
                        commandsModalContent.innerHTML = '';  // Clear previous content

                        awsCliCommands.forEach(command => {
                            const commandContainer = document.createElement('div');
                            commandContainer.classList.add('command-container', 'd-flex', 'my-2');

                            const input = document.createElement('input');
                            input.setAttribute('type', 'text');
                            input.setAttribute('value', command);
                            input.classList.add('form-control');

                            const executeButton = document.createElement('button');
                            executeButton.setAttribute('type', 'button');
                            executeButton.classList.add('btn', 'mb-0', 'bg-gradient-primary');
                            executeButton.textContent = 'Execute';

                            // Add an event listener to the execute button
                            executeButton.addEventListener('click', () => {
                                const commandValue = input.value.trim();
                                if (!commandValue) {
                                    swal("Warning", "Please enter a command before executing.", "warning");
                                    return;
                                }

                                // Show the loader while the request is being processed
                                showLoader();

                                // Call the Flask route with the command value
                                fetch('/execute_command', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ command: commandValue })
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP Error: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.status === "success") {
                                        swal("Success", `Command executed successfully`, "success");
                                        console.log('Command executed:', data);
                                    } else {
                                        swal("Error", `Error executing command:\n${data.message.error || "Unknown error occurred."}`, "error");
                                        console.error('Command execution failed:', data);
                                    }
                                })
                                .catch(error => {
                                    swal("Error", `Error executing command:\n${error.message}`, "error");
                                    console.error('Error executing command:', error);
                                })
                                .finally(() => {
                                    // Hide the loader when the request is complete
                                    hideLoader();
                                });
                            });

                            commandContainer.appendChild(input);
                            commandContainer.appendChild(executeButton);
                            commandsModalContent.appendChild(commandContainer);
                        });

                        // Show the commands modal
                        const commandsModal = new bootstrap.Modal(document.getElementById('commandsModal'));
                        commandsModal.show();
                    };

                    // Hide loader
                    hideLoader();
                })
                .catch((error) => {
                    console.error('Error:', error);
                    // Hide loader in case of error
                    hideLoader();
                });
            });
        });
    });
</script>
<script>
    document.querySelector('#download').addEventListener('click', function () {
    showLoader();

    // Assume the file will download in 5 seconds
    setTimeout(() => {
        hideLoader();
    }, 8000); // Adjust this time based on your average download duration
});
</script>
{% endblock %}
